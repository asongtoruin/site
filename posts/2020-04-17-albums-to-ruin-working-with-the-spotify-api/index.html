<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://kit.fontawesome.com/5063c00b10.js"></script>
  
    <title>Albums to Ruin: working with the Spotify API :: ruszkow.ski — data, graphs and other nonsense</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="Introduction This post is a continuation of the development of my Albums to Ruin Twitter bot. This is the first part of actual development of the bot - information on the concept and outline can be found in the Initial Concept post.
In this post, I&amp;rsquo;m going to cover the process required for getting the recently played tracks from Spotify and the URL for the album art.
Getting Started First of all, we need to register an application with Spotify."/>
<meta name="keywords" content=""/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="https://ruszkow.ski/posts/2020-04-17-albums-to-ruin-working-with-the-spotify-api/" />


<link rel="stylesheet" href="https://ruszkow.ski/assets/style.css">

  <link rel="stylesheet" href="https://ruszkow.ski/assets/green.css">



<link rel="stylesheet" href="https://ruszkow.ski/style.css">


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://ruszkow.ski/img/apple-touch-icon-144-precomposed.png">

<link rel="shortcut icon" href="https://ruszkow.ski/img/favicon/green.png">



<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="Albums to Ruin: working with the Spotify API :: ruszkow.ski — data, graphs and other nonsense" />
<meta name="twitter:description" content="Introduction This post is a continuation of the development of my Albums to Ruin Twitter bot. This is the first part of actual development of the bot - information on the concept and outline can be found in the Initial Concept post.
In this post, I&amp;rsquo;m going to cover the process required for getting the recently played tracks from Spotify and the URL for the album art.
Getting Started First of all, we need to register an application with Spotify." />
<meta name="twitter:site" content="https://ruszkow.ski" />
<meta name="twitter:creator" content="Adam" />
<meta name="twitter:image" content="">


<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Albums to Ruin: working with the Spotify API :: ruszkow.ski — data, graphs and other nonsense">
<meta property="og:description" content="Introduction This post is a continuation of the development of my Albums to Ruin Twitter bot. This is the first part of actual development of the bot - information on the concept and outline can be found in the Initial Concept post.
In this post, I&amp;rsquo;m going to cover the process required for getting the recently played tracks from Spotify and the URL for the album art.
Getting Started First of all, we need to register an application with Spotify." />
<meta property="og:url" content="https://ruszkow.ski/posts/2020-04-17-albums-to-ruin-working-with-the-spotify-api/" />
<meta property="og:site_name" content="Albums to Ruin: working with the Spotify API" />
<meta property="og:image" content="">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

<meta property="article:published_time" content="2020-04-17 11:30:00 &#43;0100 &#43;0100" />











</head>
<body class="">



<div class="container center">


  
    <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    ruszkow.ski
  </div>
</a>

    </div>
    <div class="menu-trigger">menu</div>
  </div>
  
    <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/posts">Posts</a></li>
        
      
        
          <li><a href="/graphs">Graphs</a></li>
        
      
        
          <li><a href="/about">About</a></li>
        
      
      
    

    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/posts">Posts</a></li>
      
    
      
        <li><a href="/graphs">Graphs</a></li>
      
    
      
        <li><a href="/about">About</a></li>
      
    
    
  </ul>
</nav>

  
</header>

  

  <div class="content">
    
<div class="post">
  <h1 class="post-title">
  <a href="https://ruszkow.ski/posts/2020-04-17-albums-to-ruin-working-with-the-spotify-api/">Albums to Ruin: working with the Spotify API</a></h1>
<div class="post-meta">
    
    <span class="post-date">
      <i class="fas fa-calendar-day"></i> 2020-04-17
    </span>
    
    
    <span class="post-author">::
      <i class="fas fa-user"></i> Adam
    </span>
    
    <span class='post-reading-time'>::
     <i class="fas fa-clock"></i> 8 minutes
    </span>
</div>


<span class="post-tags">
  
  #<a href="https://ruszkow.ski/tags/albums-to-ruin/">Albums to Ruin</a>&nbsp;
  
  #<a href="https://ruszkow.ski/tags/python/">Python</a>&nbsp;
  
</span>


  
  <div class="post-content">
    

<h2 id="introduction">Introduction</h2>

<p>This post is a continuation of the development of my <em>Albums to Ruin</em> Twitter
bot. This is the first part of actual development of the bot - information
on the concept and outline can be found in the
<a href="/posts/2020-04-14-albums-to-ruin-initial-concept/">Initial Concept post</a>.</p>

<p>In this post, I&rsquo;m going to cover the process required for getting the recently
played tracks from Spotify and the URL for the album art.</p>

<h2 id="getting-started">Getting Started</h2>

<p>First of all, we need to register an application with Spotify. This is done via
the <a href="https://developer.spotify.com/dashboard/applications">Developer Dashboard</a>
and is relatively straightforward. This provides us with the <code>Client ID</code> and
<code>Client Secret</code> keys that let us access the APIs.</p>

<p>While we&rsquo;re here, we also need to set up a Redirect URI. For other Spotify apps,
this will be the address the user is redirected to once they log in. For the
time being, we&rsquo;ll only be using the account we&rsquo;re logged into the developer
console with, so this is not critical, but we need <em>something</em> here to ensure
we can connect properly later on.</p>

<p>Clicking on the application and then clicking on <em>Edit Settings</em> should allow
you to add in a Redirect URI. Setting this to <code>http://localhost:8888/callback</code>
gives us something we can work with later on. The settings page will look
something like this:</p>


  <div class="img-outer">
    <a href="https://ruszkow.ski/img/posts/albums-to-ruin/redirect_uri.png" target="_blank">
      <img class="scaled-img" src="https://ruszkow.ski/img/posts/albums-to-ruin/redirect_uri.png">
    </a>
  </div>



<p>Next, we need to set up our Python environment. For the purposes of this project,
I&rsquo;m going to be using the <code>spotipy</code> <a href="https://github.com/plamere/spotipy">library</a>
(latest version at time of writing is 2.1.1) as it&rsquo;s lightweight and has
<a href="https://spotipy.readthedocs.io/">good documentation</a>. Spotipy lets you pass
your <code>Client ID</code> and <code>Client Secret</code> keys either through parameters or through
environment variables - for ease of sharing the code, I&rsquo;m going to use
environment variables. The Spotipy documentation has good advice for setting
this up, particularly for Windows. In Linux (e.g. on a Raspberry Pi), it&rsquo;s a
little more fiddly than I&rsquo;m used to as you need to make sure it&rsquo;s set
permanently. I did this through <code>~/etc/profile</code>. Now we should be ready to go.</p>

<h2 id="authenticating">Authenticating</h2>

<p>The first step in connecting to the API is authenticating. First, we&rsquo;ll request
a token allowing access to the endpoint we require. Spotipy should be able to
cache this token and refresh it when needed, so you should only need to call
this section of the code once ever. This is the first time we need our Redirect
URI, and if you want to run this code yourself you&rsquo;ll need to replace my
username with your own.</p>

<pre><code class="language-python">import spotipy.util as util

token = util.prompt_for_user_token(
    'valeadam', scope='user-read-recently-played', 
    redirect_uri='http://localhost:8888/callback'
)
</code></pre>

<p>If you run this, your web browser should load asking for permission to connect
your application to your Spotify account. Once this is approved, we should be
clear to start accessing our information.</p>

<p>Now we need to set up an authenticated connection. Spotipy makes this fairly
easy via its <code>Spotify</code> and <code>SpotifyOAuth</code> classes. Again, if you wanted to run
this you&rsquo;d need to replace my username with your own.</p>

<pre><code class="language-python">import spotipy
from spotipy.oauth2 import SpotifyClientCredentials


auth = spotipy.SpotifyOAuth(
    redirect_uri='http://localhost:8888/callback', username='valeadam'
)

sp = spotipy.Spotify(auth_manager=auth)
print(sp.me())
</code></pre>

<p>This prints out some information about the connected user:</p>

<pre><code class="language-python">{
    'display_name': 'valeadam',
    'external_urls': {'spotify': 'https://open.spotify.com/user/valeadam'},
    'followers': {'href': None, 'total': 39},
    'href': 'https://api.spotify.com/v1/users/valeadam',
    'id': 'valeadam',
    'images': [],
    'type': 'user',
    'uri': 'spotify:user:valeadam'
}
</code></pre>

<p>If it doesn&rsquo;t, there may be some error in your process. Double-check your
username is correct, and that the <code>SPOTIPY_CLIENT_ID</code> and
<code>SPOTIPY_CLIENT_SECRET</code> environment variables are set up correctly.</p>

<h2 id="getting-recently-played-tracks">Getting recently played tracks</h2>

<p>Now we have our authenticated connection, we can use this to access our recently
played tracks. This can be done through the <code>current_user_recently_played()</code>
method of our <code>Spotify</code> object. This provides (a lot of) information on the 50
most recently played tracks as a Python dictionary. The method returns
track-level information, but for the purposes of this bot we actually only want
the album-level data. I&rsquo;ve cleared out information irrelevant to the task at
hand with ellipses, for a more complete example consult the
<a href="https://developer.spotify.com/documentation/web-api/reference/player/get-recently-played/">Spotify web api reference</a>
for this method.The information I&rsquo;ll want to access for the Twitter bot is
structured as follows:</p>

<pre><code class="language-python">{
    'items':
        [
            {'track': {'album': {'album_type': 'album',
                                 'artists': [
                                     {'external_urls': {'spotify': '...'},
                                      'href': '...',
                                      'id': '4xYk2flbrS0hDzDLyDimbO',
                                      'name': 'Tubelord',
                                      'type': 'artist',
                                      'uri': 'spotify:artist:4xYk2flbrS0hDzDLyDimbO'
                                      }],
                                 # ...
                                 'external_urls': {'spotify': '...'},
                                 # ...
                                 'images': [{'height': 640,
                                             'url': '...',
                                             'width': 640
                                             },
                                            {'height': 300,
                                             'url': '...',
                                             'width': 300
                                             },
                                            {'height': 64,
                                             'url': '...',
                                             'width': 64
                                             }],
                                 'name': 'Our First American Friends',
                                 'release_date': '2009',
                                 'release_date_precision': 'year',
                                 'total_tracks': 10,
                                 'type': 'album',
                                 'uri': 'spotify:album:4nXbDzk9hxR8aUMkBvpV6u'
                                 },
                       # ...
                       },
             # ...
             },
             # ...
        ]
}
</code></pre>

<p>There&rsquo;s a few things we can note from this. Firstly, there&rsquo;s the possibility of
multiple artists showing up on one album. It would be nice to be able simply
combine them all into a comma-separated list, as this is likely how I&rsquo;d want to
include this information in the corresponding tweet. The only issue here is it&rsquo;s
unclear how compilations are dealt with - would 20 artists on a compilation each
appear individually? If so, we might risk going past the tweet length limit. A
simple way of avoiding this issue is to replace the returned set of artists if
they exceed a certain length. We&rsquo;ll arbitrarily set this to 5.</p>

<p>Secondly, multiple sizes of artwork are returned. For the best result, we want
the largest image provided. It looks as though the images are ordered by size
from largest to smallest, but it&rsquo;s not too complicated to add an extra bit of
processing to ensure we do indeed get the largest.</p>

<p>Now we can begin to construct our class for the album object. There are a few
other things we might want to think about:</p>

<ul>
<li><p>If multiple tracks are played from the same album, the album will appear in
the response multiple times. As such, we some way to check if two of our
objects correspond to the same album so we can remove duplicates. Doing this
through the <code>__eq__</code> magic method makes sense here, and allows us to directly
use <code>==</code>.</p></li>

<li><p>Thinking ahead for the tweets, we might also want a nice string version of the
album information to include with the image. We can use another magic method
for this - <code>__str__</code> - so we&rsquo;ll add this too.</p></li>

<li><p>If we&rsquo;re going to be adding the data to a database, it&rsquo;ll help to have a quick
way to access all of the attributes of each album object. The <code>__dict__</code>
magic method does this, but isn&rsquo;t a particularly nice method of access.
Additionally, we may end up wanting to exclude certain attributes from the
returned dictionary. Adding another method gives us this flexibilty.</p></li>
</ul>

<p>Putting these things together gets us the following class:</p>

<pre><code class="language-python">class SpotifyAlbum:
    def __init__(self, resp_dict):
        self.name = resp_dict.get('name', None)
        self.release_date = resp_dict.get('release_date', 'Unknown')

        # Handle possibility of many artists
        artists = resp_dict['artists']
        if len(artists) &gt; 5:
            self.artists = 'Various'
        else:
            self.artists = ', '.join(
                art.get('name', 'Unknown') for art in artists
            )
        
        urls = resp_dict.get('external_urls', {'spotify': None})
        self.link = urls['spotify']
        
        # Get the largest version of the album artwork
        images = resp_dict.get('images', [{'url': None, 'height': 0}])
        images.sort(key=lambda x: x['height'], reverse=True)
        self.art_link = images[0]['url']
    
    def __str__(self):
        return (
            f'Album Name: {self.name}\n'
            f'Artist(s): {self.artists}\n'
            f'Released: {self.release_date}\n'
            f'Link: {self.link}'
        )
    
    def __eq__(self, other):
        if type(other) is type(self):
            return self.__dict__ == other.__dict__
        return NotImplemented
    
    def to_dict(self):
        return self.__dict__
</code></pre>

<p>This should give us the basic amount of information we need. As a last step for
this section, we might want to consider how we can get the unique albums from
the most recent 50 played tracks. This API returns the most recently played
track first in the list, whereas for my Twitter bot I want to have the albums
posted in the order they&rsquo;ve been encountered. This means reversing the items
passed by the API. It also means we can&rsquo;t just use <code>set</code>, as it ignores order.
It&rsquo;s not a huge issue, as we need just a few lines of code:</p>

<pre><code class="language-python">recently_played = sp.current_user_recently_played()

recent_albums = []

for item in recently_played['items'][::-1]:
    album = SpotifyAlbum(item['track']['album'])
    if album.art_link and not any(prev == album for prev in recent_albums):
        recent_albums.append(album)
</code></pre>

<p>Now, via <code>recent_albums</code>, we have a list of unique recently played albums in the
order in which they&rsquo;ve been played. This gives us the starting point for the
rest of the project. Putting all the code together, we get the following:</p>

<pre><code class="language-python">import spotipy
from spotipy.oauth2 import SpotifyClientCredentials


class SpotifyAlbum:
    def __init__(self, resp_dict):
        self.name = resp_dict.get('name', None)
        self.release_date = resp_dict.get('release_date', 'Unknown')
        self.artists = ', '.join(
            a.get('name', 'Unknown') for a in resp_dict['artists']
        )
        
        urls = resp_dict.get('external_urls', {'spotify': None})
        self.link = urls['spotify']
        
        images = resp_dict.get('images', [{'url': None, 'height': 0}])
        images.sort(key=lambda x: x['height'], reverse=True)
        self.art_link = images[0]['url']
    
    def __str__(self):
        return (
            f'Album: {self.name}\n'
            f'Artist(s): {self.artists}\n'
            f'Released: {self.release_date}\n'
            f'Link: {self.link}'
        )
    
    def __eq__(self, other):
        if type(other) is type(self):
            return self.__dict__ == other.__dict__
        return NotImplemented
    
    def to_dict(self):
        return self.__dict__

if __name__ == '__main__':
    auth = spotipy.SpotifyOAuth(
        redirect_uri='http://localhost:8888', username='valeadam'
    )

    sp = spotipy.Spotify(auth_manager=auth)

    recently_played = sp.current_user_recently_played()

    recent_albums = []

    for item in recently_played['items'][::-1]:
        album = SpotifyAlbum(item['track']['album'])
        if album.art_link and not any(prev == album for prev in recent_albums):
            recent_albums.append(album)
</code></pre>

  </div>
  
  <div class="pagination">
    <div class="pagination__title">
      <span
        class="pagination__title-h">Read other posts</span>
      <hr />
    </div>
    <div class="pagination__buttons">
      
      <span class="button previous">
        <a href="https://ruszkow.ski/posts/2020-04-20-albums-to-ruin-database-operations/">
          <span class="button__icon">←</span>
          <span class="button__text">Albums to Ruin: database operations</span>
        </a>
      </span>
      
      
      <span class="button next">
        <a href="https://ruszkow.ski/posts/2020-04-14-albums-to-ruin-initial-concept/">
          <span class="button__text">Albums to Ruin: Initial Concept</span>
          <span class="button__icon">→</span>
        </a>
      </span>
      
    </div>
  </div>
  

  

</div>

  </div>

  
    
      <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2020 Powered by <a href="http://gohugo.io">Hugo</a></span>
    
        <span>:: Theme made by <a href="https://twitter.com/panr">panr</a></span>
      </div>
  </div>
</footer>

<script src="https://ruszkow.ski/assets/main.js"></script>
<script src="https://ruszkow.ski/assets/prism.js"></script>





    
  
</div>

</body>
</html>
